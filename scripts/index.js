const moment = require("moment");
const { ethers } = require("hardhat");
const { deployErc20Contract } = require("./erc20");
const { formatEther } = ethers.utils;
const {
  abi,
  bytecode,
} = require("../artifacts/contracts/BDLockingContract.sol/BDLockingContract.json");

async function deployDBLockingContract(
  signer,
  beneficiaryAddresses,
  startTimestamp,
  durationSeconds,
  cliffDurationSeconds
) {
  const bytecode =
    "0x60e06040523480156200001157600080fd5b5060405162000fe938038062000fe98339810160408190526200003491620003d6565b60005b8451816001600160401b03161015620001125760006001600160a01b031685826001600160401b0316815181106200007f57634e487b7160e01b600052603260045260246000fd5b60200260200101516001600160a01b03161415620000fd5760405162461bcd60e51b815260206004820152603060248201527f42444c6f636b696e67436f6e74726163743a20412062656e656669636961727960448201526f206973207a65726f206164647265737360801b60648201526084015b60405180910390fd5b806200010981620004fe565b91505062000037565b50816001600160401b0316816001600160401b031610620001b15760405162461bcd60e51b815260206004820152605c602482015260008051602062000fc983398151915260448201527f6f662074686520636c69666620706572696f64206d75737420656e642062656660648201527f6f72652074686520656e74697265206c6f636b757020706572696f6400000000608482015260a401620000f4565b6303c26700826001600160401b03161115620002395760405162461bcd60e51b815260206004820152604b602482015260008051602062000fc983398151915260448201527f6f6620746865206c6f636b696e6720706572696f642063616e6f6f742065786360648201526a656564203220796561727360a81b608482015260a401620000f4565b62000249426301e13380620004e3565b836001600160401b03161115620002d75760405162461bcd60e51b8152602060048201526044602482018190527f42444c6f636b696e67436f6e74726163743a20546865206c6f636b696e672070908201527f6572696f64206d7573742073746172742077697468696e203336352066726f6d606482015263206e6f7760e01b608482015260a401620000f4565b6001600160c01b031960c082901b166080528351620002fe90600290602087019062000320565b50506001600160c01b031960c092831b811660a05290821b1690525062000554565b82805482825590600052602060002090810192821562000378579160200282015b828111156200037857825182546001600160a01b0319166001600160a01b0390911617825560209092019160019091019062000341565b50620003869291506200038a565b5090565b5b808211156200038657600081556001016200038b565b80516001600160a01b0381168114620003b957600080fd5b919050565b80516001600160401b0381168114620003b957600080fd5b60008060008060808587031215620003ec578384fd5b84516001600160401b038082111562000403578586fd5b818701915087601f83011262000417578586fd5b81516020828211156200042e576200042e6200053e565b8160051b604051601f19603f830116810181811086821117156200045657620004566200053e565b604052838152828101945085830182870184018d101562000475578a8bfd5b8a96505b84871015620004a2576200048d81620003a1565b86526001969096019594830194830162000479565b509850620004b49050898201620003be565b965050505050620004c860408601620003be565b9150620004d860608601620003be565b905092959194509250565b60008219821115620004f957620004f962000528565b500190565b60006001600160401b03828116808214156200051e576200051e62000528565b6001019392505050565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052604160045260246000fd5b60805160c01c60a05160c01c60c05160c01c610a28620005a1600039600081816084015281816104b5015261050a0152600061038d015260008181610131015261045e0152610a286000f3fe608060405234801561001057600080fd5b506004361061007d5760003560e01c80638ff8fe501161005b5780638ff8fe50146100eb5780639852595c146100fe578063be9a655514610127578063d85349f71461012f57600080fd5b80630fb5a6b41461008257806319165587146100c15780631d29bd5a146100d6575b600080fd5b7f000000000000000000000000000000000000000000000000000000000000000067ffffffffffffffff165b6040519081526020015b60405180910390f35b6100d46100cf3660046107d5565b61015f565b005b6100de61026e565b6040516100b89190610885565b6100ae6100f93660046107ef565b6102d0565b6100ae61010c3660046107d5565b6001600160a01b031660009081526001602052604090205490565b6100ae610382565b7f000000000000000000000000000000000000000000000000000000000000000067ffffffffffffffff166100ae565b6001600160a01b03811660009081526001602052604081205461018283426102d0565b61018c9190610950565b6001600160a01b0383166000908152600160205260408120805492935083929091906101b9908490610905565b90915550506040518181526001600160a01b038316907fc0e523490dd523c33b1878c9eb14ff46991e3f5b2cd33710918618f2a39cba1b9060200160405180910390a2600061020661026e565b905060006102158383516103b0565b905060005b8251811015610267576102558584838151811061024757634e487b7160e01b600052603260045260246000fd5b6020026020010151846103e9565b8061025f81610997565b91505061021a565b5050505050565b606060028054806020026020016040519081016040528092919081815260200182805480156102c657602002820191906000526020600020905b81546001600160a01b031681526001909101906020018083116102a8575b5050505050905090565b6001600160a01b03821660009081526001602052604081205481906040516370a0823160e01b81523060048201526001600160a01b038616906370a082319060240160206040518083038186803b15801561032a57600080fd5b505afa15801561033e573d6000803e3d6000fd5b505050506040513d601f19601f820116820180604052508101906103629190610851565b61036c9190610905565b90506103788184610440565b9150505b92915050565b67ffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000001690565b60006103bc82846109b2565b156103c85760016103cb565b60005b60ff166103d8838561091d565b6103e29190610905565b9392505050565b604080516001600160a01b038416602482015260448082018490528251808303909101815260649091019091526020810180516001600160e01b031663a9059cbb60e01b17905261043b90849061056a565b505050565b600061044a610382565b8267ffffffffffffffff1610806104a657507f000000000000000000000000000000000000000000000000000000000000000067ffffffffffffffff1661048f610382565b6104999190610905565b8267ffffffffffffffff16105b156104b35750600061037c565b7f000000000000000000000000000000000000000000000000000000000000000067ffffffffffffffff166104e6610382565b6104f09190610905565b8267ffffffffffffffff16111561050857508161037c565b7f000000000000000000000000000000000000000000000000000000000000000067ffffffffffffffff1661053b610382565b61054f9067ffffffffffffffff8516610950565b6105599085610931565b610563919061091d565b905061037c565b60006105bf826040518060400160405280602081526020017f5361666545524332303a206c6f772d6c6576656c2063616c6c206661696c6564815250856001600160a01b03166106419092919063ffffffff16565b80519091501561043b57808060200190518101906105dd9190610831565b61043b5760405162461bcd60e51b815260206004820152602a60248201527f5361666545524332303a204552433230206f7065726174696f6e20646964206e6044820152691bdd081cdd58d8d9595960b21b60648201526084015b60405180910390fd5b60606106508484600085610658565b949350505050565b6060824710156106b95760405162461bcd60e51b815260206004820152602660248201527f416464726573733a20696e73756666696369656e742062616c616e636520666f6044820152651c8818d85b1b60d21b6064820152608401610638565b843b6107075760405162461bcd60e51b815260206004820152601d60248201527f416464726573733a2063616c6c20746f206e6f6e2d636f6e74726163740000006044820152606401610638565b600080866001600160a01b031685876040516107239190610869565b60006040518083038185875af1925050503d8060008114610760576040519150601f19603f3d011682016040523d82523d6000602084013e610765565b606091505b5091509150610775828286610780565b979650505050505050565b6060831561078f5750816103e2565b82511561079f5782518084602001fd5b8160405162461bcd60e51b815260040161063891906108d2565b80356001600160a01b03811681146107d057600080fd5b919050565b6000602082840312156107e6578081fd5b6103e2826107b9565b60008060408385031215610801578081fd5b61080a836107b9565b9150602083013567ffffffffffffffff81168114610826578182fd5b809150509250929050565b600060208284031215610842578081fd5b815180151581146103e2578182fd5b600060208284031215610862578081fd5b5051919050565b6000825161087b818460208701610967565b9190910192915050565b6020808252825182820181905260009190848201906040850190845b818110156108c65783516001600160a01b0316835292840192918401916001016108a1565b50909695505050505050565b60208152600082518060208401526108f1816040850160208701610967565b601f01601f19169190910160400192915050565b60008219821115610918576109186109c6565b500190565b60008261092c5761092c6109dc565b500490565b600081600019048311821515161561094b5761094b6109c6565b500290565b600082821015610962576109626109c6565b500390565b60005b8381101561098257818101518382015260200161096a565b83811115610991576000848401525b50505050565b60006000198214156109ab576109ab6109c6565b5060010190565b6000826109c1576109c16109dc565b500690565b634e487b7160e01b600052601160045260246000fd5b634e487b7160e01b600052601260045260246000fdfea2646970667358221220b79e8ddca0fc25e7c9a88c18af1c3c3bf78cb6dd791ce007cd207f588f8d623364736f6c6343000804003342444c6f636b696e67436f6e74726163743a20546865206475726174696f6e20";

  const abi = [
    "constructor(address[] memory beneficiariesAddresses, uint64 startTimestamp, uint64 durationSeconds, uint64 cliffDurationSeconds)",
    "function beneficiaries() public view returns (address[] memory)",
    "function start() public view returns (uint256)",
    "function duration() public view returns (uint256)",
    "function cliffDuration() public view returns (uint256)",
    "function released(address token) public view returns (uint256)",
    "function release(address token) public",
    "function freedAmount(address token, uint64 timestamp) public view returns (uint256)",
  ];
  const factory = new ethers.ContractFactory(abi, bytecode, signer);
  const contract = await factory.deploy(
    beneficiaryAddresses,
    startTimestamp,
    durationSeconds,
    cliffDurationSeconds
  );
  console.log("BDLockingContract deployed to:", contract.address);

  await contract.deployTransaction.wait();
  return contract;
}

function createSigner() {
  const url = "http://localhost:8545";
  const provider = new ethers.providers.JsonRpcProvider(url);
  const signer = provider.getSigner();
  return signer;
}

async function main() {
  const signer = createSigner();

  const erc20TotalSupply = 100000;
  const beneficiariesAddresses = await signer.getAddress();
  const startMoment = moment();
  const startTimestamp = Math.ceil(Date.now() / 1000);
  // const startTimestamp = Math.ceil(new Date().setFullYear(new Date().getFullYear() + 2) / 1000); // Test start not within 1 year
  // const durationSeconds = 60 * 60 * 24 * 365 * 2 + 1; // Test duration less than 2 years
  const durationSeconds = 900;
  const cliffDurationSeconds = 500;
  // const cliffDurationSeconds = durationSeconds + 1; // Test cliff larger than duration
  const [erc20, locking] = await Promise.all([
    deployErc20Contract(signer, erc20TotalSupply),
    deployDBLockingContract(
      signer,
      [beneficiariesAddresses],
      startTimestamp,
      durationSeconds,
      cliffDurationSeconds
    ),
  ]);

  const transferAmount = erc20TotalSupply;
  await erc20.transfer(locking.address, transferAmount);

  let allocationTimestamp = Math.ceil(
    startMoment.add(10, "s").toDate().getTime() / 1000
  );

  console.log("expected start", startTimestamp);
  console.log("actual start", (await locking.start()).toString());
  console.log("=========================");
  console.log("expected durationSeconds", durationSeconds.toString());
  console.log("actual duration", (await locking.duration()).toString());
  console.log("=========================");
  console.log("expected cliff", cliffDurationSeconds);
  console.log("actual cliff", (await locking.cliffDuration()).toString());
  console.log("=========================");

  const expectedTotalAllocation = transferAmount;

  console.log("totalAllocation", expectedTotalAllocation);
  console.log("timestamp - start()", allocationTimestamp - startTimestamp);
  console.log("expected Freed", 0);

  let freed = await locking.freedAmount(erc20.address, allocationTimestamp);
  console.log("actual Freed", freed.toString());

  allocationTimestamp = Math.ceil(
    startMoment
      .add(cliffDurationSeconds + 10, "s")
      .toDate()
      .getTime() / 1000
  );
  const expectedFreed =
    (expectedTotalAllocation * (allocationTimestamp - startTimestamp)) /
    durationSeconds;

  console.log("timestamp - start()", allocationTimestamp - startTimestamp);
  console.log("expected Freed", expectedFreed);

  freed = await locking.freedAmount(erc20.address, allocationTimestamp);
  console.log("actual Freed", freed.toString());
}

main()
  .then(() => process.exit(0))
  .catch((error) => {
    console.error(error);
    process.exit(1);
  });
